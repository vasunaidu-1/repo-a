name: Prod Orchestrator
run-name: prod-orchestrator-${{ inputs.action }}

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment
      environment:
        type: choice
        options:
          - prod-west
          - prod-east
          - prod-west-followed-by-prod-east
        default: prod-west

# =========================================================
# BUILD PLAN (WEST / SINGLE ENV)
# =========================================================
jobs:
  orchestrate:
    name: Build Release Plan
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
      region: ${{ steps.set-region.outputs.region }}
      has_repo_a: ${{ steps.plan.outputs.has_repo_a }}
      has_repo_b: ${{ steps.plan.outputs.has_repo_b }}
      has_repo_c: ${{ steps.plan.outputs.has_repo_c }}

    steps:
      - uses: actions/checkout@v4

      - name: Set region
        id: set-region
        run: |
          if [[ "${{ inputs.environment }}" == "prod-west" || "${{ inputs.environment }}" == "prod-west-followed-by-prod-east" ]]; then
            echo "region=us-west-2" >> "$GITHUB_OUTPUT"
          else
            echo "region=us-east-1" >> "$GITHUB_OUTPUT"
          fi

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ steps.set-region.outputs.region }}

      - name: Download manifest
        run: |
          aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - name: Build plan and summary
        id: plan
        shell: bash
        run: |
          set -euo pipefail
          REGION="${{ steps.set-region.outputs.region }}"
          DATA=$(yq -o=json ".\"$REGION\"" manifest.yaml)
          HAS_A=false
          HAS_B=false
          HAS_C=false
          PLAN_JSON='[]'

          echo "## ${{ inputs.environment }} Build & Release Plan" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Version |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|---------|" >> "$GITHUB_STEP_SUMMARY"

          for repo in repo-a repo-b repo-c; do
            VERSION=$(echo "$DATA" | jq -r ".\"$repo\".version // empty")
            if [[ "$VERSION" == "NA" ]]; then
              echo "| $repo | Skipped |" >> "$GITHUB_STEP_SUMMARY"
            elif [[ -n "$VERSION" && "$VERSION" != "null" ]]; then
              echo "| $repo | v$VERSION |" >> "$GITHUB_STEP_SUMMARY"
              PLAN_JSON=$(echo "$PLAN_JSON" | jq ". + [{\"repo\":\"$repo\",\"version\":\"$VERSION\"}]")
              [[ "$repo" == "repo-a" ]] && HAS_A=true
              [[ "$repo" == "repo-b" ]] && HAS_B=true
              [[ "$repo" == "repo-c" ]] && HAS_C=true
            fi
          done

          echo "plan_b64=$(echo "$PLAN_JSON" | base64 -w0)" >> "$GITHUB_OUTPUT"
          echo "has_repo_a=$HAS_A" >> "$GITHUB_OUTPUT"
          echo "has_repo_b=$HAS_B" >> "$GITHUB_OUTPUT"
          echo "has_repo_c=$HAS_C" >> "$GITHUB_OUTPUT"

# =========================================================
# APPROVAL (WEST OR SINGLE)
# =========================================================
  approval:
    name: Approve Release Plan
    needs: orchestrate
    runs-on: ubuntu-latest
    environment: prod-west
    steps:
      - run: echo "Approved"

# =========================================================
# TRIGGERS (WEST)
# =========================================================
  trigger-repo-a:
    if: needs.orchestrate.outputs.has_repo_a == 'true'
    needs: [orchestrate, approval]
    runs-on: ubuntu-latest
    steps:
      - run: echo "repo-a west triggered"

  trigger-repo-b:
    if: needs.orchestrate.outputs.has_repo_b == 'true'
    needs: [orchestrate, approval]
    runs-on: ubuntu-latest
    steps:
      - run: echo "repo-b west triggered"

  trigger-repo-c:
    if: needs.orchestrate.outputs.has_repo_c == 'true'
    needs: [orchestrate, approval]
    runs-on: ubuntu-latest
    steps:
      - run: echo "repo-c west triggered"

# =========================================================
# EAST FLOW (ONLY WHEN FOLLOWED MODE)
# =========================================================
  orchestrate-east:
    name: Build Release Plan (prod-east)
    if: inputs.environment == 'prod-west-followed-by-prod-east'
    needs: [trigger-repo-a, trigger-repo-b, trigger-repo-c]
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
      has_repo_a: ${{ steps.plan.outputs.has_repo_a }}
      has_repo_b: ${{ steps.plan.outputs.has_repo_b }}
      has_repo_c: ${{ steps.plan.outputs.has_repo_c }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Download manifest
        run: |
          aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - name: Build plan and summary
        id: plan
        run: |
          set -euo pipefail
          REGION="us-east-1"
          DATA=$(yq -o=json ".\"$REGION\"" manifest.yaml)
          HAS_A=false
          HAS_B=false
          HAS_C=false
          PLAN_JSON='[]'

          echo "## prod-east Build & Release Plan" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Version |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|---------|" >> "$GITHUB_STEP_SUMMARY"

          for repo in repo-a repo-b repo-c; do
            VERSION=$(echo "$DATA" | jq -r ".\"$repo\".version // empty")
            if [[ "$VERSION" == "NA" ]]; then
              echo "| $repo | Skipped |" >> "$GITHUB_STEP_SUMMARY"
            elif [[ -n "$VERSION" && "$VERSION" != "null" ]]; then
              echo "| $repo | v$VERSION |" >> "$GITHUB_STEP_SUMMARY"
              PLAN_JSON=$(echo "$PLAN_JSON" | jq ". + [{\"repo\":\"$repo\",\"version\":\"$VERSION\"}]")
              [[ "$repo" == "repo-a" ]] && HAS_A=true
              [[ "$repo" == "repo-b" ]] && HAS_B=true
              [[ "$repo" == "repo-c" ]] && HAS_C=true
            fi
          done

          echo "plan_b64=$(echo "$PLAN_JSON" | base64 -w0)" >> "$GITHUB_OUTPUT"
          echo "has_repo_a=$HAS_A" >> "$GITHUB_OUTPUT"
          echo "has_repo_b=$HAS_B" >> "$GITHUB_OUTPUT"
          echo "has_repo_c=$HAS_C" >> "$GITHUB_OUTPUT"

# =========================================================
# APPROVAL (EAST)
# =========================================================
  approval-east:
    if: inputs.environment == 'prod-west-followed-by-prod-east'
    needs: orchestrate-east
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo "Approved prod-east"

# =========================================================
# TRIGGERS (EAST)
# =========================================================
  trigger-repo-a-east:
    if: needs.orchestrate-east.outputs.has_repo_a == 'true'
    needs: [orchestrate-east, approval-east]
    runs-on: ubuntu-latest
    steps:
      - run: echo "repo-a east triggered"

  trigger-repo-b-east:
    if: needs.orchestrate-east.outputs.has_repo_b == 'true'
    needs: [orchestrate-east, approval-east]
    runs-on: ubuntu-latest
    steps:
      - run: echo "repo-b east triggered"

  trigger-repo-c-east:
    if: needs.orchestrate-east.outputs.has_repo_c == 'true'
    needs: [orchestrate-east, approval-east]
    runs-on: ubuntu-latest
    steps:
      - run: echo "repo-c east triggered"
