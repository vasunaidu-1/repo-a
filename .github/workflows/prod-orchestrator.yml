name: Prod Orchestrator
run-name: prod-orchestrator-${{ inputs.action }}

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment
      environment:
        type: choice
        options:
          - prod-west
          - prod-east
          - prod-west-followed-by-prod-east
        default: prod-west

# =========================================================
# COMMON PLAN (prod-west OR prod-east)
# =========================================================
jobs:
  orchestrate:
    name: Build Release Plan
    if: inputs.environment != 'prod-west-followed-by-prod-east'
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
      region: ${{ steps.region.outputs.region }}
      has_repo_a: ${{ steps.plan.outputs.has_repo_a }}
      has_repo_b: ${{ steps.plan.outputs.has_repo_b }}
      has_repo_c: ${{ steps.plan.outputs.has_repo_c }}

    steps:
      - uses: actions/checkout@v4

      - id: region
        run: |
          [[ "${{ inputs.environment }}" == "prod-west" ]] \
            && echo "region=us-west-2" >> $GITHUB_OUTPUT \
            || echo "region=us-east-1" >> $GITHUB_OUTPUT

      - run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ steps.region.outputs.region }}

      - run: aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - id: plan
        run: |
          DATA=$(yq -o=json ".\"${{ steps.region.outputs.region }}\"" manifest.yaml)
          PLAN='[]'; A=false; B=false; C=false

          echo "## prod-${{ inputs.environment }} Build & Release Plan" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY

          for r in repo-a repo-b repo-c; do
            v=$(echo "$DATA" | jq -r ".\"$r\".version // empty")
            if [[ "$v" == "NA" ]]; then
              echo "| $r | Skipped (version = NA) |" >> $GITHUB_STEP_SUMMARY
            elif [[ -n "$v" ]]; then
              echo "| $r | v$v |" >> $GITHUB_STEP_SUMMARY
              PLAN=$(echo "$PLAN" | jq ". + [{\"repo\":\"$r\",\"version\":\"$v\"}]")
              [[ "$r" == "repo-a" ]] && A=true
              [[ "$r" == "repo-b" ]] && B=true
              [[ "$r" == "repo-c" ]] && C=true
            fi
          done

          echo "plan_b64=$(echo "$PLAN" | base64 -w0)" >> $GITHUB_OUTPUT
          echo "has_repo_a=$A" >> $GITHUB_OUTPUT
          echo "has_repo_b=$B" >> $GITHUB_OUTPUT
          echo "has_repo_c=$C" >> $GITHUB_OUTPUT

# =========================================================
# APPROVAL (single env)
# =========================================================
  approval:
    if: inputs.environment != 'prod-west-followed-by-prod-east'
    needs: orchestrate
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo Approved

# =========================================================
# TRIGGERS (single env)
# =========================================================
  trigger-repo-a:
    if: inputs.environment != 'prod-west-followed-by-prod-east' && needs.orchestrate.outputs.has_repo_a == 'true'
    needs: [orchestrate, approval]
    runs-on: ubuntu-latest
    steps:
      - run: |
          P=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 -d)
          V=$(echo "$P" | jq -r '.[] | select(.repo=="repo-a") | .version')
          curl -X POST -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/vasunaidu-1/repo-a/actions/workflows/prod-deploy.yml/dispatches \
          -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"$V\",\"environment\":\"${{ inputs.environment }}\",\"region\":\"${{ needs.orchestrate.outputs.region }}\"}}"

  trigger-repo-c:
    if: inputs.environment != 'prod-west-followed-by-prod-east' && needs.orchestrate.outputs.has_repo_c == 'true'
    needs: [orchestrate, approval]
    runs-on: ubuntu-latest
    steps:
      - run: |
          P=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 -d)
          V=$(echo "$P" | jq -r '.[] | select(.repo=="repo-c") | .version')
          curl -X POST -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/vasunaidu-1/repo-c/actions/workflows/prod-deploy.yml/dispatches \
          -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"$V\",\"environment\":\"${{ inputs.environment }}\",\"region\":\"${{ needs.orchestrate.outputs.region }}\"}}"

# =========================================================
# WEST â†’ EAST MODE
# =========================================================
  west:
    if: inputs.environment == 'prod-west-followed-by-prod-east'
    runs-on: ubuntu-latest
    steps:
      - run: echo "WEST PHASE COMPLETE"

  approval-east:
    if: inputs.environment == 'prod-west-followed-by-prod-east'
    needs: west
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo "Approved EAST"

  east:
    if: inputs.environment == 'prod-west-followed-by-prod-east'
    needs: approval-east
    runs-on: ubuntu-latest
    steps:
      - run: echo "EAST PHASE COMPLETE"
