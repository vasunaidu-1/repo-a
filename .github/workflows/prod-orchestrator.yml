name: Prod Orchestrator
run-name: prod-orchestrator-${{ inputs.action }}

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options:
          - deployment
          - rollback
        default: deployment
      environment:
        type: choice
        options:
          - prod-west
          - prod-east
          - prod-west followed by prod-east
        default: prod-west followed by prod-east

# =========================================================
# PROD-WEST : BUILD & PLAN
# =========================================================
jobs:
  plan-west:
    name: Build & Plan (prod-west)
    if: contains(inputs.environment, 'prod-west')
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Configure AWS (west)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Download manifest from S3
        run: |
          aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - name: Build release plan summary (west)
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          DATA=$(yq -o=json '.["us-west-2"]' manifest.yaml)

          PLAN_JSON=$(echo "$DATA" | jq -c '
            to_entries
            | map(select(.value.version != "NA"))
            | map({repo: .key, version: .value.version})
          ')

          echo "## ðŸ“¦ prod-west Release Plan" >> "$GITHUB_STEP_SUMMARY"
          echo "| Repo | Version |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|---------|" >> "$GITHUB_STEP_SUMMARY"

          echo "$DATA" | jq -r '
            to_entries[]
            | if .value.version == "NA"
              then "| \(.key) | â­ skipped (NA) |"
              else "| \(.key) | v\(.value.version) |"
              end
          ' >> "$GITHUB_STEP_SUMMARY"

          echo "plan_b64=$(echo "$PLAN_JSON" | base64 -w0)" >> "$GITHUB_OUTPUT"

# =========================================================
# PROD-WEST : APPROVAL
# =========================================================
  approve-west:
    name: Approve prod-west
    needs: plan-west
    if: contains(inputs.environment, 'prod-west')
    runs-on: ubuntu-latest
    environment: prod-west
    steps:
      - run: echo "prod-west approved"

# =========================================================
# PROD-WEST : TRIGGER (FIXED â€“ LINKS ALWAYS SHOWN)
# =========================================================
  trigger-west:
    name: Trigger prod-west repos
    needs: approve-west
    if: contains(inputs.environment, 'prod-west')
    runs-on: ubuntu-latest

    steps:
      - name: Trigger repos and generate summary (west)
        shell: bash
        run: |
          set -euo pipefail

          PLAN=$(echo '${{ needs.plan-west.outputs.plan_b64 }}' | base64 -d)

          echo "## ðŸš€ prod-west Trigger Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### âœ… Triggered Repositories" >> "$GITHUB_STEP_SUMMARY"

          if [[ "$(echo "$PLAN" | jq length)" -eq 0 ]]; then
            echo "_No repositories triggered_" >> "$GITHUB_STEP_SUMMARY"
          else
            for row in $(echo "$PLAN" | jq -c '.[]'); do
              repo=$(echo "$row" | jq -r '.repo')
              version=$(echo "$row" | jq -r '.version')

              curl -f -X POST \
                -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/vasunaidu-1/$repo/actions/workflows/prod-deploy.yml/dispatches \
                -d "{
                  \"ref\": \"main\",
                  \"inputs\": {
                    \"tag\": \"$version\",
                    \"environment\": \"prod-west\",
                    \"region\": \"us-west-2\"
                  }
                }"

              echo "- Triggered-$repo" >> "$GITHUB_STEP_SUMMARY"
              echo "  ðŸ‘‰ https://github.com/vasunaidu-1/$repo/actions/workflows/prod-deploy.yml" >> "$GITHUB_STEP_SUMMARY"
            done
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### â­ Skipped Repositories (NA in manifest)" >> "$GITHUB_STEP_SUMMARY"

          yq -r '.["us-west-2"] | to_entries[] | select(.value.version=="NA") | "- Skipped-\(.key)"' manifest.yaml \
            >> "$GITHUB_STEP_SUMMARY"

# =========================================================
# PROD-EAST : BUILD & PLAN
# =========================================================
  plan-east:
    name: Build & Plan (prod-east)
    needs: trigger-west
    if: inputs.environment != 'prod-west'
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Configure AWS (east)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Download manifest from S3
        run: |
          aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - name: Build release plan summary (east)
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          DATA=$(yq -o=json '.["us-east-1"]' manifest.yaml)

          PLAN_JSON=$(echo "$DATA" | jq -c '
            to_entries
            | map(select(.value.version != "NA"))
            | map({repo: .key, version: .value.version})
          ')

          echo "## ðŸ“¦ prod-east Release Plan" >> "$GITHUB_STEP_SUMMARY"
          echo "| Repo | Version |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|---------|" >> "$GITHUB_STEP_SUMMARY"

          echo "$DATA" | jq -r '
            to_entries[]
            | if .value.version == "NA"
              then "| \(.key) | â­ skipped (NA) |"
              else "| \(.key) | v\(.value.version) |"
              end
          ' >> "$GITHUB_STEP_SUMMARY"

          echo "plan_b64=$(echo "$PLAN_JSON" | base64 -w0)" >> "$GITHUB_OUTPUT"

# =========================================================
# PROD-EAST : APPROVAL
# =========================================================
  approve-east:
    name: Approve prod-east
    needs: plan-east
    if: inputs.environment != 'prod-west'
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo "prod-east approved"

# =========================================================
# PROD-EAST : TRIGGER
# =========================================================
  trigger-east:
    name: Trigger prod-east repos
    needs: approve-east
    if: inputs.environment != 'prod-west'
    runs-on: ubuntu-latest

    steps:
      - name: Trigger repos and generate summary (east)
        shell: bash
        run: |
          set -euo pipefail

          PLAN=$(echo '${{ needs.plan-east.outputs.plan_b64 }}' | base64 -d)

          echo "## ðŸš€ prod-east Trigger Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### âœ… Triggered Repositories" >> "$GITHUB_STEP_SUMMARY"

          if [[ "$(echo "$PLAN" | jq length)" -eq 0 ]]; then
            echo "_No repositories triggered_" >> "$GITHUB_STEP_SUMMARY"
          else
            for row in $(echo "$PLAN" | jq -c '.[]'); do
              repo=$(echo "$row" | jq -r '.repo')
              version=$(echo "$row" | jq -r '.version')

              curl -f -X POST \
                -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/vasunaidu-1/$repo/actions/workflows/prod-deploy.yml/dispatches \
                -d "{
                  \"ref\": \"main\",
                  \"inputs\": {
                    \"tag\": \"$version\",
                    \"environment\": \"prod-east\",
                    \"region\": \"us-east-1\"
                  }
                }"

              echo "- Triggered-$repo" >> "$GITHUB_STEP_SUMMARY"
              echo "  ðŸ‘‰ https://github.com/vasunaidu-1/$repo/actions/workflows/prod-deploy.yml" >> "$GITHUB_STEP_SUMMARY"
            done
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### â­ Skipped Repositories (NA in manifest)" >> "$GITHUB_STEP_SUMMARY"

          yq -r '.["us-east-1"] | to_entries[] | select(.value.version=="NA") | "- Skipped-\(.key)"' manifest.yaml \
            >> "$GITHUB_STEP_SUMMARY"
