name: Prod Orchestrator
run-name: prod-orchestrator-${{ inputs.action }}-${{ inputs.environment }}

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment
      environment:
        type: choice
        options:
          - prod-west
          - prod-east
          - prod-west followed by prod-east
        default: prod-west

# =========================================================
# BUILD & PLAN
# =========================================================
jobs:
  plan:
    name: Build Release Plan
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
      region: ${{ steps.region.outputs.region }}

    steps:
      - name: Set region
        id: region
        run: |
          if [[ "${{ inputs.environment }}" == "prod-east" ]]; then
            echo "region=us-east-1" >> $GITHUB_OUTPUT
          else
            echo "region=us-west-2" >> $GITHUB_OUTPUT
          fi

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ steps.region.outputs.region }}

      - name: Download manifest
        run: aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - name: Build plan & summary
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          REGION="${{ steps.region.outputs.region }}"
          DATA=$(yq -o=json ".\"$REGION\"" manifest.yaml)

          PLAN='[]'

          echo "## Release Orchestration Overview" >> $GITHUB_STEP_SUMMARY
          echo "**Operation:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY

          for repo in repo-a repo-b repo-c; do
            version=$(echo "$DATA" | jq -r ".\"$repo\".version")
            if [[ "$version" != "NA" && "$version" != "null" ]]; then
              echo "| $repo | v$version |" >> $GITHUB_STEP_SUMMARY
              PLAN=$(echo "$PLAN" | jq ". + [{\"repo\":\"$repo\",\"version\":\"$version\"}]")
            else
              echo "| $repo | NA (skipped) |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "plan_b64=$(echo "$PLAN" | base64 -w0)" >> $GITHUB_OUTPUT

# =========================================================
# APPROVAL
# =========================================================
  approve:
    name: Approve Release Plan
    needs: plan
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "Approved"

# =========================================================
# TRIGGER + LINKS SUMMARY
# =========================================================
  trigger:
    name: Trigger Repositories
    needs: approve
    runs-on: ubuntu-latest

    steps:
      - name: Trigger repos and show links
        shell: bash
        run: |
          PLAN=$(echo '${{ needs.plan.outputs.plan_b64 }}' | base64 -d)

          echo "## ðŸš€ ${{ inputs.environment }} Repositories Triggered" >> $GITHUB_STEP_SUMMARY
          echo "Click the links below to approve deployments:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Approval Link |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|---------------|" >> $GITHUB_STEP_SUMMARY

          for row in $(echo "$PLAN" | jq -c '.[]'); do
            repo=$(echo "$row" | jq -r '.repo')
            version=$(echo "$row" | jq -r '.version')

            curl -f -X POST \
              -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/vasunaidu-1/$repo/actions/workflows/prod-deploy.yml/dispatches \
              -d "{
                \"ref\":\"main\",
                \"inputs\":{
                  \"tag\":\"$version\",
                  \"environment\":\"${{ inputs.environment }}\",
                  \"region\":\"${{ needs.plan.outputs.region }}\"
                }
              }"

            echo "| $repo | https://github.com/vasunaidu-1/$repo/actions/workflows/prod-deploy.yml |" >> $GITHUB_STEP_SUMMARY
          done
