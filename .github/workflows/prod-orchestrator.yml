name: Prod Orchestrator
run-name: prod-orchestrator-${{ inputs.action }}

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment
      environment:
        type: choice
        options: [prod-west, prod-east]
        default: prod-west

jobs:
# =========================================================
# PLAN & SUMMARY
# =========================================================
  orchestrate:
    name: Plan & Summary
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
      region: ${{ steps.set-region.outputs.region }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------
      # Set region from environment
      # -------------------------------
      - name: Set region
        id: set-region
        run: |
          if [[ "${{ inputs.environment }}" == "prod-west" ]]; then
            echo "region=us-west-2" >> "$GITHUB_OUTPUT"
          else
            echo "region=us-east-1" >> "$GITHUB_OUTPUT"
          fi

      # -------------------------------
      # Install required tools
      # -------------------------------
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      # -------------------------------
      # Configure AWS credentials
      # -------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ steps.set-region.outputs.region }}

      # -------------------------------
      # Download manifest from S3
      # -------------------------------
      - name: Download manifest
        run: |
          aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      # -------------------------------
      # Build deployment / rollback plan
      # -------------------------------
      - name: Build release plan and summary
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          REGION="${{ steps.set-region.outputs.region }}"
          DATA=$(yq -o=json ".\"$REGION\"" manifest.yaml)

          echo "## ðŸš€ Release Orchestration Overview" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [[ "${{ inputs.action }}" == "deployment" ]]; then
            echo "This pipeline prepares and validates the release plan based on the deployment manifest." >> "$GITHUB_STEP_SUMMARY"
            echo "It provides full visibility into what services will be deployed, which versions will be used, and the target environment." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "After the plan is reviewed and manually approved, the orchestrator triggers deployments for each service sequentially." >> "$GITHUB_STEP_SUMMARY"
            echo "Each service deployment is governed by repository-level approvals and controls, ensuring safe, auditable, and controlled production releases." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "This pipeline prepares and validates a rollback plan based on the rollback manifest." >> "$GITHUB_STEP_SUMMARY"
            echo "It provides full visibility into which services will be rolled back, which versions will be restored, and the target environment." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "After the rollback plan is reviewed and manually approved, the orchestrator triggers rollback executions for each service sequentially." >> "$GITHUB_STEP_SUMMARY"
            echo "Each service rollback is governed by repository-level approvals and controls, ensuring safe, auditable, and controlled production recovery." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Operation:** ${{ inputs.action }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Environment:** ${{ inputs.environment }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "| Service | Version |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|---------|" >> "$GITHUB_STEP_SUMMARY"

          PLAN_JSON='[]'

          for repo in repo-a repo-b repo-c; do
            VERSION=$(echo "$DATA" | jq -r ".\"$repo\".version")
            if [[ "$VERSION" != "null" && "$VERSION" != "not_applicable" ]]; then
              echo "| $repo | v$VERSION |" >> "$GITHUB_STEP_SUMMARY"
              PLAN_JSON=$(echo "$PLAN_JSON" | jq ". + [{\"repo\":\"$repo\",\"version\":\"$VERSION\"}]")
            fi
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "> âœ… This run is explicitly executed as **${{ inputs.action }}** for traceability and audit purposes." >> "$GITHUB_STEP_SUMMARY"

          echo "plan_b64=$(echo "$PLAN_JSON" | base64 -w 0)" >> "$GITHUB_OUTPUT"

# =========================================================
# APPROVE RELEASE / ROLLBACK PLAN
# =========================================================
  approval:
    name: Approve Release Plan
    needs: orchestrate
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "Plan approved"

# =========================================================
# TRIGGER repo-a
# =========================================================
  trigger-repo-a:
    name: Trigger repo-a
    needs:
      - orchestrate
      - approval
    runs-on: ubuntu-latest
    steps:
      - run: |
          set -euo pipefail
          PLAN_JSON=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 --decode)
          VERSION=$(echo "$PLAN_JSON" | jq -r '.[] | select(.repo=="repo-a") | .version')
          [ -z "$VERSION" ] && exit 0

          curl -f -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/vasunaidu-1/repo-a/actions/workflows/prod-deploy.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"$VERSION\",\"environment\":\"${{ inputs.environment }}\",\"region\":\"${{ needs.orchestrate.outputs.region }}\"}}"

# =========================================================
# TRIGGER repo-b
# =========================================================
  trigger-repo-b:
    name: Trigger repo-b
    needs:
      - orchestrate
      - trigger-repo-a
    runs-on: ubuntu-latest
    steps:
      - run: |
          set -euo pipefail
          PLAN_JSON=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 --decode)
          VERSION=$(echo "$PLAN_JSON" | jq -r '.[] | select(.repo=="repo-b") | .version')
          [ -z "$VERSION" ] && exit 0

          curl -f -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/vasunaidu-1/repo-b/actions/workflows/prod-deploy.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"$VERSION\",\"environment\":\"${{ inputs.environment }}\",\"region\":\"${{ needs.orchestrate.outputs.region }}\"}}"

# =========================================================
# TRIGGER repo-c
# =========================================================
  trigger-repo-c:
    name: Trigger repo-c
    needs:
      - orchestrate
      - trigger-repo-b
    runs-on: ubuntu-latest
    steps:
      - run: |
          set -euo pipefail
          PLAN_JSON=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 --decode)
          VERSION=$(echo "$PLAN_JSON" | jq -r '.[] | select(.repo=="repo-c") | .version')
          [ -z "$VERSION" ] && exit 0

          curl -f -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/vasunaidu-1/repo-c/actions/workflows/prod-deploy.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"$VERSION\",\"environment\":\"${{ inputs.environment }}\",\"region\":\"${{ needs.orchestrate.outputs.region }}\"}}"
