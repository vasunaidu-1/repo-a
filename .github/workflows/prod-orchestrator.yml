name: Prod Orchestrator

run-name: >
  ${{ inputs.action == 'rollback' && 'prod-rollback' || 'prod-deploy' }}

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment

      target_repos:
        type: choice
        description: "Select target repositories"
        options:
          - all
          - repo-a
          - repo-b
          - repo-c
          - repo-a,repo-b
          - repo-a,repo-c
          - repo-b,repo-c
          - repo-a,repo-b,repo-c
        default: all

      environment:
        type: choice
        options: [prod-west, prod-east]
        default: prod-west

      region:
        type: choice
        options: [us-west-2, us-east-1]
        default: us-west-2

jobs:
# =========================================================
# ORCHESTRATE (PLAN + SUMMARY)
# =========================================================
  orchestrate:
    name: Orchestrate Release
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Download manifest
        run: |
          aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - id: plan
        shell: bash
        run: |
          REGION="${{ inputs.region }}"
          TARGET="${{ inputs.target_repos }}"
          ACTION="${{ inputs.action }}"

          DATA=$(yq -o=json ".\"$REGION\"" manifest.yaml)
          PLAN_JSON='[]'

          # ---------------- SUMMARY (THEORY PART) ----------------
          if [ "$ACTION" = "rollback" ]; then
            TITLE="Rollback Summary"
            ACTION_TEXT="rollback"
          else
            TITLE="Deployment Summary"
            ACTION_TEXT="deployment"
          fi

          echo "## ðŸš€ $TITLE" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ðŸ“– Overview" >> "$GITHUB_STEP_SUMMARY"
          echo "This workflow orchestrates a **$ACTION_TEXT** across multiple repositories." >> "$GITHUB_STEP_SUMMARY"
          echo "Each repository is processed **independently**, protected by a **manual approval gate**." >> "$GITHUB_STEP_SUMMARY"
          echo "Only repositories explicitly selected at trigger time are executed." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Target repositories:** $TARGET" >> "$GITHUB_STEP_SUMMARY"
          echo "**Environment:** ${{ inputs.environment }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Region:** $REGION" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ðŸ“¦ Execution Plan" >> "$GITHUB_STEP_SUMMARY"
          echo "| Repo | Action | Version |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|---------|" >> "$GITHUB_STEP_SUMMARY"

          for repo in repo-a repo-b repo-c; do
            if [[ "$TARGET" != "all" && ! ",$TARGET," =~ ",$repo," ]]; then
              echo "| $repo | Skipped | NA |" >> "$GITHUB_STEP_SUMMARY"
              continue
            fi

            VERSION=$(echo "$DATA" | jq -r ".\"$repo\".version")
            if [[ "$VERSION" == "null" || "$VERSION" == "not_applicable" ]]; then
              echo "| $repo | Skipped | NA |" >> "$GITHUB_STEP_SUMMARY"
              continue
            fi

            echo "| $repo | $ACTION_TEXT | v$VERSION |" >> "$GITHUB_STEP_SUMMARY"
            PLAN_JSON=$(echo "$PLAN_JSON" | jq ". + [{\"repo\":\"$repo\",\"version\":\"$VERSION\"}]")
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "_This summary is generated automatically for audit and traceability._" >> "$GITHUB_STEP_SUMMARY"

          echo "plan_b64=$(echo "$PLAN_JSON" | base64 -w 0)" >> "$GITHUB_OUTPUT"

# =========================================================
# repo-a
# =========================================================
  approval-repo-a:
    name: Approval â€¢ repo-a
    needs: orchestrate
    if: ${{ inputs.target_repos == 'all' || contains(inputs.target_repos, 'repo-a') }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "Approved repo-a"

  deploy-repo-a:
    name: ${{ inputs.action == 'rollback' && 'Rollback â€¢ repo-a' || 'Deploy â€¢ repo-a' }}
    needs: approval-repo-a
    if: ${{ inputs.target_repos == 'all' || contains(inputs.target_repos, 'repo-a') }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          PLAN=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 --decode)
          VERSION=$(echo "$PLAN" | jq -r '.[] | select(.repo=="repo-a") | .version')
          [ -z "$VERSION" ] && exit 0
          echo "Executing repo-a ($VERSION)"

# =========================================================
# repo-b
# =========================================================
  approval-repo-b:
    name: Approval â€¢ repo-b
    needs: orchestrate
    if: ${{ inputs.target_repos == 'all' || contains(inputs.target_repos, 'repo-b') }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "Approved repo-b"

  deploy-repo-b:
    name: ${{ inputs.action == 'rollback' && 'Rollback â€¢ repo-b' || 'Deploy â€¢ repo-b' }}
    needs: approval-repo-b
    if: ${{ inputs.target_repos == 'all' || contains(inputs.target_repos, 'repo-b') }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          PLAN=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 --decode)
          VERSION=$(echo "$PLAN" | jq -r '.[] | select(.repo=="repo-b") | .version')
          [ -z "$VERSION" ] && exit 0
          echo "Executing repo-b ($VERSION)"

# =========================================================
# repo-c
# =========================================================
  approval-repo-c:
    name: Approval â€¢ repo-c
    needs: orchestrate
    if: ${{ inputs.target_repos == 'all' || contains(inputs.target_repos, 'repo-c') }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "Approved repo-c"

  deploy-repo-c:
    name: ${{ inputs.action == 'rollback' && 'Rollback â€¢ repo-c' || 'Deploy â€¢ repo-c' }}
    needs: approval-repo-c
    if: ${{ inputs.target_repos == 'all' || contains(inputs.target_repos, 'repo-c') }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          PLAN=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 --decode)
          VERSION=$(echo "$PLAN" | jq -r '.[] | select(.repo=="repo-c") | .version')
          [ -z "$VERSION" ] && exit 0
          echo "Executing repo-c ($VERSION)"
