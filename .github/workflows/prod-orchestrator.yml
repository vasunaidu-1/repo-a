name: Prod Orchestrator
run-name: prod-orchestrator-${{ inputs.action }}

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment
      environment:
        type: choice
        options:
          - prod-west
          - prod-east
          - prod-west-followed-by-prod-east
        default: prod-west

###########################################################
# ===================== PROD WEST ========================
###########################################################
jobs:

  plan-west:
    if: inputs.environment == 'prod-west' || inputs.environment == 'prod-west-followed-by-prod-east'
    runs-on: ubuntu-latest
    outputs:
      repo_matrix: ${{ steps.plan.outputs.repo_matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Download manifest
        run: aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - name: Build matrix
        id: plan
        run: |
          DATA=$(yq -o=json ".\"us-west-2\"" manifest.yaml)
          MATRIX=$(echo "$DATA" | jq -c '[to_entries[] | select(.value.version != null and .value.version != "NA") | {repo: .key, version: .value.version}]')
          echo "repo_matrix=$MATRIX" >> $GITHUB_OUTPUT

  approve-west:
    if: inputs.environment == 'prod-west' || inputs.environment == 'prod-west-followed-by-prod-east'
    needs: plan-west
    runs-on: ubuntu-latest
    environment: prod-west
    steps:
      - run: echo "Approved prod-west"

  trigger-west:
    if: inputs.environment == 'prod-west' || inputs.environment == 'prod-west-followed-by-prod-east'
    needs: [plan-west, approve-west]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.plan-west.outputs.repo_matrix) }}
    steps:
      - name: Trigger ${{ matrix.repo }}
        run: |
          curl -f -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/vasunaidu-1/${{ matrix.repo }}/dispatches \
            -d "{
              \"event_type\": \"prod-deploy\",
              \"client_payload\": {
                \"tag\": \"${{ matrix.version }}\",
                \"environment\": \"prod-west\",
                \"region\": \"us-west-2\",
                \"operation\": \"${{ inputs.action }}\"
              }
            }"

###########################################################
# ===================== PROD EAST ========================
###########################################################

  plan-east:
    if: inputs.environment == 'prod-east'
    runs-on: ubuntu-latest
    outputs:
      repo_matrix: ${{ steps.plan.outputs.repo_matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Download manifest
        run: aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - name: Build matrix
        id: plan
        run: |
          DATA=$(yq -o=json ".\"us-east-1\"" manifest.yaml)
          MATRIX=$(echo "$DATA" | jq -c '[to_entries[] | select(.value.version != null and .value.version != "NA") | {repo: .key, version: .value.version}]')
          echo "repo_matrix=$MATRIX" >> $GITHUB_OUTPUT

  approve-east:
    if: inputs.environment == 'prod-east'
    needs: plan-east
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo "Approved prod-east"

  trigger-east:
    if: inputs.environment == 'prod-east'
    needs: [plan-east, approve-east]
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1   # ðŸ”¥ Sequential
      matrix:
        include: ${{ fromJson(needs.plan-east.outputs.repo_matrix) }}
    steps:
      - name: Trigger ${{ matrix.repo }}
        run: |
          curl -f -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/vasunaidu-1/${{ matrix.repo }}/dispatches \
            -d "{
              \"event_type\": \"prod-deploy\",
              \"client_payload\": {
                \"tag\": \"${{ matrix.version }}\",
                \"environment\": \"prod-east\",
                \"region\": \"us-east-1\",
                \"operation\": \"${{ inputs.action }}\"
              }
            }"

###########################################################
# ========== PROD WEST â†’ PROD EAST ========================
###########################################################

  trigger-east-after-west:
    if: inputs.environment == 'prod-west-followed-by-prod-east'
    needs: trigger-west
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        include: ${{ fromJson(needs.plan-west.outputs.repo_matrix) }}
    steps:
      - name: Trigger ${{ matrix.repo }}
        run: |
          curl -f -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/vasunaidu-1/${{ matrix.repo }}/dispatches \
            -d "{
              \"event_type\": \"prod-deploy\",
              \"client_payload\": {
                \"tag\": \"${{ matrix.version }}\",
                \"environment\": \"prod-east\",
                \"region\": \"us-east-1\",
                \"operation\": \"${{ inputs.action }}\"
              }
            }"
