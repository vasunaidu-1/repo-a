name: Prod Orchestrator

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment
      environment:
        type: choice
        options: [prod-west, prod-east]
        default: prod-west
      region:
        type: choice
        options: [us-west-2, us-east-1]
        default: us-west-2

jobs:
  orchestrate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.region }}

      - name: Download manifest
        run: |
          aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - name: Build plan + summary
        shell: bash
        run: |
          REGION="${{ inputs.region }}"
          DATA=$(yq -o=json ".\"$REGION\"" manifest.yaml)

          echo "## ðŸš€ Deployment Plan" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Action:** ${{ inputs.action }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Environment:** ${{ inputs.environment }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Region:** $REGION" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### ðŸ“Œ What will happen" >> "$GITHUB_STEP_SUMMARY"
          echo "- Only repos with valid versions will be deployed" >> "$GITHUB_STEP_SUMMARY"
          echo "- Each repo will pause for manual approval" >> "$GITHUB_STEP_SUMMARY"
          echo "- Deployment is handled by shared workflow" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "| Repo | Status | Version |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|---------|" >> "$GITHUB_STEP_SUMMARY"

          for repo in repo-a repo-b repo-c; do
            VERSION=$(echo "$DATA" | jq -r ".\"$repo\".version")

            if [[ "$VERSION" == "null" || "$VERSION" == "not_applicable" ]]; then
              echo "| $repo | Skipped | NA |" >> "$GITHUB_STEP_SUMMARY"
              continue
            fi

            echo "| $repo | Deploy | v$VERSION |" >> "$GITHUB_STEP_SUMMARY"

            curl -f -X POST \
              -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/vasunaidu-1/$repo/actions/workflows/prod-deploy.yml/dispatches \
              -d "{
                    \"ref\":\"main\",
                    \"inputs\":{
                      \"tag\":\"$VERSION\",
                      \"environment\":\"${{ inputs.environment }}\"
                    }
                  }"
          done
