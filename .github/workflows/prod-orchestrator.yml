name: Prod Orchestrator

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment
      environment:
        type: choice
        options:
          - prod-west
          - prod-east
          - prod-west-followed-by-prod-east
        default: prod-west

jobs:
# =========================================================
# PROD-WEST FLOW
# =========================================================
  orchestrate-west:
    if: inputs.environment != 'prod-east'
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
      has_repo_a: ${{ steps.plan.outputs.has_repo_a }}
      has_repo_b: ${{ steps.plan.outputs.has_repo_b }}
      has_repo_c: ${{ steps.plan.outputs.has_repo_c }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Download manifest
        run: aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - id: plan
        run: |
          DATA=$(yq -o=json '.["us-west-2"]' manifest.yaml)
          HAS_A=false; HAS_B=false; HAS_C=false; PLAN='[]'
          for r in repo-a repo-b repo-c; do
            v=$(echo "$DATA" | jq -r ".\"$r\".version // empty")
            if [[ -n "$v" && "$v" != "NA" && "$v" != "null" ]]; then
              PLAN=$(echo "$PLAN" | jq ". + [{\"repo\":\"$r\",\"version\":\"$v\"}]")
              [[ "$r" == "repo-a" ]] && HAS_A=true
              [[ "$r" == "repo-b" ]] && HAS_B=true
              [[ "$r" == "repo-c" ]] && HAS_C=true
            fi
          done
          echo "plan_b64=$(echo "$PLAN" | base64 -w0)" >> $GITHUB_OUTPUT
          echo "has_repo_a=$HAS_A" >> $GITHUB_OUTPUT
          echo "has_repo_b=$HAS_B" >> $GITHUB_OUTPUT
          echo "has_repo_c=$HAS_C" >> $GITHUB_OUTPUT

  approval-west:
    if: inputs.environment != 'prod-east'
    needs: orchestrate-west
    runs-on: ubuntu-latest
    environment: prod-west
    steps:
      - run: echo "Approved prod-west"

# =========================================================
# PROD-EAST FLOW
# =========================================================
  orchestrate-east:
    needs: approval-west
    if: inputs.environment != 'prod-west'
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
      has_repo_a: ${{ steps.plan.outputs.has_repo_a }}
      has_repo_b: ${{ steps.plan.outputs.has_repo_b }}
      has_repo_c: ${{ steps.plan.outputs.has_repo_c }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Download manifest
        run: aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - id: plan
        run: |
          DATA=$(yq -o=json '.["us-east-1"]' manifest.yaml)
          HAS_A=false; HAS_B=false; HAS_C=false; PLAN='[]'
          for r in repo-a repo-b repo-c; do
            v=$(echo "$DATA" | jq -r ".\"$r\".version // empty")
            if [[ -n "$v" && "$v" != "NA" && "$v" != "null" ]]; then
              PLAN=$(echo "$PLAN" | jq ". + [{\"repo\":\"$r\",\"version\":\"$v\"}]")
              [[ "$r" == "repo-a" ]] && HAS_A=true
              [[ "$r" == "repo-b" ]] && HAS_B=true
              [[ "$r" == "repo-c" ]] && HAS_C=true
            fi
          done
          echo "plan_b64=$(echo "$PLAN" | base64 -w0)" >> $GITHUB_OUTPUT
          echo "has_repo_a=$HAS_A" >> $GITHUB_OUTPUT
          echo "has_repo_b=$HAS_B" >> $GITHUB_OUTPUT
          echo "has_repo_c=$HAS_C" >> $GITHUB_OUTPUT

  approval-east:
    if: inputs.environment != 'prod-west'
    needs: orchestrate-east
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo "Approved prod-east"
