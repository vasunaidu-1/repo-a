name: Prod Orchestrator
run-name: prod-orchestrator-${{ inputs.action }}

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment
      environment:
        type: choice
        options:
          - prod-west
          - prod-east
          - prod-west-followed-by-prod-east
        default: prod-west

########################################
# PROD WEST ONLY
########################################
jobs:
  plan-west:
    if: inputs.environment == 'prod-west' || inputs.environment == 'prod-west-followed-by-prod-east'
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y jq
      - run: |
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-west-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - run: aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml
      - id: plan
        run: |
          DATA=$(yq -o=json ".\"us-west-2\"" manifest.yaml)
          PLAN_JSON='[]'
          for repo in repo-a repo-b repo-c; do
            VERSION=$(echo "$DATA" | jq -r ".\"$repo\".version // empty")
            [[ -z "$VERSION" || "$VERSION" == "NA" ]] && continue
            PLAN_JSON=$(echo "$PLAN_JSON" | jq ". + [{\"repo\":\"$repo\",\"version\":\"$VERSION\"}]")
          done
          echo "plan_b64=$(echo "$PLAN_JSON" | base64 -w0)" >> "$GITHUB_OUTPUT"

  approve-west:
    if: inputs.environment == 'prod-west' || inputs.environment == 'prod-west-followed-by-prod-east'
    needs: plan-west
    runs-on: ubuntu-latest
    environment: prod-west
    steps:
      - run: echo approved

  trigger-west:
    if: inputs.environment == 'prod-west' || inputs.environment == 'prod-west-followed-by-prod-east'
    needs: [plan-west, approve-west]
    runs-on: ubuntu-latest
    steps:
      - run: |
          PLAN=$(echo "${{ needs.plan-west.outputs.plan_b64 }}" | base64 -d)
          echo "## prod-west Repositories Triggered" >> "$GITHUB_STEP_SUMMARY"
          echo "| Repo | Workflow |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|----------|" >> "$GITHUB_STEP_SUMMARY"
          for r in $(echo "$PLAN" | jq -r '.[].repo'); do
            curl -X POST -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
              https://api.github.com/repos/vasunaidu-1/$r/dispatches \
              -d '{"event_type":"prod-deploy"}'
            echo "| $r | https://github.com/vasunaidu-1/$r/actions |" >> "$GITHUB_STEP_SUMMARY"
          done

########################################
# PROD EAST ONLY
########################################
  plan-east:
    if: inputs.environment == 'prod-east'
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - run: aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml
      - id: plan
        run: |
          DATA=$(yq -o=json ".\"us-east-1\"" manifest.yaml)
          PLAN_JSON='[]'
          for repo in repo-a repo-b repo-c; do
            VERSION=$(echo "$DATA" | jq -r ".\"$repo\".version // empty")
            [[ -z "$VERSION" || "$VERSION" == "NA" ]] && continue
            PLAN_JSON=$(echo "$PLAN_JSON" | jq ". + [{\"repo\":\"$repo\",\"version\":\"$VERSION\"}]")
          done
          echo "plan_b64=$(echo "$PLAN_JSON" | base64 -w0)" >> "$GITHUB_OUTPUT"

  approve-east:
    if: inputs.environment == 'prod-east'
    needs: plan-east
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo approved

  trigger-east:
    if: inputs.environment == 'prod-east'
    needs: [plan-east, approve-east]
    runs-on: ubuntu-latest
    steps:
      - run: |
          PLAN=$(echo "${{ needs.plan-east.outputs.plan_b64 }}" | base64 -d)
          echo "## prod-east Repositories Triggered" >> "$GITHUB_STEP_SUMMARY"
          echo "| Repo | Workflow |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|----------|" >> "$GITHUB_STEP_SUMMARY"
          for r in $(echo "$PLAN" | jq -r '.[].repo'); do
            curl -X POST -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
              https://api.github.com/repos/vasunaidu-1/$r/dispatches \
              -d '{"event_type":"prod-deploy"}'
            echo "| $r | https://github.com/vasunaidu-1/$r/actions |" >> "$GITHUB_STEP_SUMMARY"
          done

########################################
# EAST AFTER WEST
########################################
  plan-east-after-west:
    if: inputs.environment == 'prod-west-followed-by-prod-east'
    needs: trigger-west
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - run: aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml
      - id: plan
        run: |
          DATA=$(yq -o=json ".\"us-east-1\"" manifest.yaml)
          PLAN_JSON='[]'
          for repo in repo-a repo-b repo-c; do
            VERSION=$(echo "$DATA" | jq -r ".\"$repo\".version // empty")
            [[ -z "$VERSION" || "$VERSION" == "NA" ]] && continue
            PLAN_JSON=$(echo "$PLAN_JSON" | jq ". + [{\"repo\":\"$repo\",\"version\":\"$VERSION\"}]")
          done
          echo "plan_b64=$(echo "$PLAN_JSON" | base64 -w0)" >> "$GITHUB_OUTPUT"

  approve-east-after-west:
    if: inputs.environment == 'prod-west-followed-by-prod-east'
    needs: plan-east-after-west
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo approved

  trigger-east-after-west:
    if: inputs.environment == 'prod-west-followed-by-prod-east'
    needs: [plan-east-after-west, approve-east-after-west]
    runs-on: ubuntu-latest
    steps:
      - run: |
          PLAN=$(echo "${{ needs.plan-east-after-west.outputs.plan_b64 }}" | base64 -d)
          echo "## prod-east Repositories Triggered" >> "$GITHUB_STEP_SUMMARY"
          echo "| Repo | Workflow |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|----------|" >> "$GITHUB_STEP_SUMMARY"
          for r in $(echo "$PLAN" | jq -r '.[].repo'); do
            curl -X POST -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
              https://api.github.com/repos/vasunaidu-1/$r/dispatches \
              -d '{"event_type":"prod-deploy"}'
            echo "| $r | https://github.com/vasunaidu-1/$r/actions |" >> "$GITHUB_STEP_SUMMARY"
          done
