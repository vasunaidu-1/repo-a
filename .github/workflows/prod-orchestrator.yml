name: Prod Orchestrator

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [deployment, rollback]
        default: deployment
      environment:
        type: choice
        options: [prod-west, prod-east]
        default: prod-west

jobs:
# =========================================================
# PLAN & SUMMARY
# =========================================================
  orchestrate:
    name: Plan & Summary
    runs-on: ubuntu-latest
    outputs:
      plan_b64: ${{ steps.plan.outputs.plan_b64 }}
      region: ${{ steps.region.outputs.region }}

    steps:
      - uses: actions/checkout@v4

      - name: Set region
        id: region
        run: |
          if [[ "${{ inputs.environment }}" == "prod-west" ]]; then
            echo "region=us-west-2" >> $GITHUB_OUTPUT
          else
            echo "region=us-east-1" >> $GITHUB_OUTPUT
          fi

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq_linux_amd64
          sudo mv yq_linux_amd64 /usr/local/bin/yq

      - name: Download manifest
        run: |
          aws s3 cp s3://mos-deploy-manifests/${{ inputs.action }}-manifest.yaml manifest.yaml

      - id: plan
        run: |
          set -euo pipefail
          DATA=$(yq -o=json ".\"${{ steps.region.outputs.region }}\"" manifest.yaml)

          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Repo | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY

          PLAN='[]'
          for repo in repo-a repo-b repo-c; do
            V=$(echo "$DATA" | jq -r ".\"$repo\".version")
            if [[ "$V" != "null" && "$V" != "not_applicable" ]]; then
              echo "| $repo | v$V |" >> $GITHUB_STEP_SUMMARY
              PLAN=$(echo "$PLAN" | jq ". + [{\"repo\":\"$repo\",\"version\":\"$V\"}]")
            fi
          done

          echo "plan_b64=$(echo "$PLAN" | base64 -w0)" >> $GITHUB_OUTPUT

# =========================================================
# APPROVE RELEASE PLAN
# =========================================================
  approve-release:
    name: Approve Release Plan
    needs: orchestrate
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "Release plan approved"

# =========================================================
# APPROVE repo-a
# =========================================================
  approve-repo-a:
    name: Approve repo-a
    needs: approve-release
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "repo-a approved"

# =========================================================
# DEPLOY repo-a (WAIT UNTIL DONE)
# =========================================================
  deploy-repo-a:
    name: Deploy repo-a
    needs:
      - orchestrate
      - approve-repo-a
    runs-on: ubuntu-latest
    steps:
      - name: Trigger & wait repo-a
        run: |
          set -euo pipefail
          PLAN=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 -d)
          VERSION=$(echo "$PLAN" | jq -r '.[] | select(.repo=="repo-a") | .version')
          [ -z "$VERSION" ] && exit 0

          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/vasunaidu-1/repo-a/actions/workflows/prod-deploy.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"$VERSION\",\"environment\":\"${{ inputs.environment }}\",\"region\":\"${{ needs.orchestrate.outputs.region }}\"}}"

          echo "Waiting for repo-a deployment..."
          while true; do
            STATUS=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
              https://api.github.com/repos/vasunaidu-1/repo-a/actions/runs \
              | jq -r '.workflow_runs[0].conclusion')

            [[ "$STATUS" == "success" ]] && break
            [[ "$STATUS" == "failure" ]] && exit 1
            sleep 15
          done

# =========================================================
# APPROVE repo-b
# =========================================================
  approve-repo-b:
    name: Approve repo-b
    needs: deploy-repo-a
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "repo-b approved"

# =========================================================
# DEPLOY repo-b
# =========================================================
  deploy-repo-b:
    name: Deploy repo-b
    needs:
      - orchestrate
      - approve-repo-b
    runs-on: ubuntu-latest
    steps:
      - run: |
          set -euo pipefail
          PLAN=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 -d)
          VERSION=$(echo "$PLAN" | jq -r '.[] | select(.repo=="repo-b") | .version')
          [ -z "$VERSION" ] && exit 0

          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/vasunaidu-1/repo-b/actions/workflows/prod-deploy.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"$VERSION\",\"environment\":\"${{ inputs.environment }}\",\"region\":\"${{ needs.orchestrate.outputs.region }}\"}}"

          echo "Waiting for repo-b deployment..."
          while true; do
            STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
              https://api.github.com/repos/vasunaidu-1/repo-b/actions/runs \
              | jq -r '.workflow_runs[0].conclusion')
            [[ "$STATUS" == "success" ]] && break
            [[ "$STATUS" == "failure" ]] && exit 1
            sleep 15
          done

# =========================================================
# APPROVE repo-c
# =========================================================
  approve-repo-c:
    name: Approve repo-c
    needs: deploy-repo-b
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "repo-c approved"

# =========================================================
# DEPLOY repo-c
# =========================================================
  deploy-repo-c:
    name: Deploy repo-c
    needs:
      - orchestrate
      - approve-repo-c
    runs-on: ubuntu-latest
    steps:
      - run: |
          set -euo pipefail
          PLAN=$(echo "${{ needs.orchestrate.outputs.plan_b64 }}" | base64 -d)
          VERSION=$(echo "$PLAN" | jq -r '.[] | select(.repo=="repo-c") | .version')
          [ -z "$VERSION" ] && exit 0

          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/vasunaidu-1/repo-c/actions/workflows/prod-deploy.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"$VERSION\",\"environment\":\"${{ inputs.environment }}\",\"region\":\"${{ needs.orchestrate.outputs.region }}\"}}"

          echo "Waiting for repo-c deployment..."
          while true; do
            STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.ORG1_PAT }}" \
              https://api.github.com/repos/vasunaidu-1/repo-c/actions/runs \
              | jq -r '.workflow_runs[0].conclusion')
            [[ "$STATUS" == "success" ]] && break
            [[ "$STATUS" == "failure" ]] && exit 1
            sleep 15
          done
